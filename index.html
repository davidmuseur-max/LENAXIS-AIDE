<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#080b10">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Lenaxis">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icon-192.png">
<title>Lenaxis V2 ‚Äî Assistant Ing√©nierie</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#080b10;--s1:#0d1117;--s2:#131922;--s3:#1a2233;--border:#1e293b;--b2:#263147;--cyan:#00c8ff;--cyan-d:#0e3d4f;--green:#00e5a0;--green-d:#0a3328;--orange:#ff9d3d;--ora-d:#3d2608;--red:#ff4d6d;--red-d:#3d0a15;--purple:#a78bfa;--purple-d:#1e1040;--txt:#cdd9ed;--muted:#546e8a;--dim:#2a3a52;--mono:'JetBrains Mono',monospace;--sans:'Space Grotesk',sans-serif;--safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px)}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{font-family:var(--sans);background:var(--bg);color:var(--txt);display:flex;flex-direction:column;height:100dvh}
.topbar{background:var(--s1);border-bottom:1px solid var(--border);padding:calc(var(--safe-top) + 10px) 16px 10px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;z-index:100}
.logo-row{display:flex;align-items:center;gap:10px}
.hex{width:30px;height:30px;flex-shrink:0}
.app-name{font-family:var(--mono);font-size:13px;font-weight:600}
.app-name span{color:var(--cyan)}
.v-badge{font-family:var(--mono);font-size:9px;background:var(--purple-d);border:1px solid rgba(167,139,250,.3);color:var(--purple);border-radius:4px;padding:2px 6px;margin-left:6px}
.status-pill{display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:10px;color:var(--muted);background:var(--s2);border:1px solid var(--border);border-radius:20px;padding:4px 10px}
.led{width:6px;height:6px;border-radius:50%;background:var(--green);box-shadow:0 0 5px var(--green);animation:blink 2s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.4}}
.mode-bar{background:var(--s1);border-bottom:1px solid var(--border);display:flex;overflow-x:auto;-webkit-overflow-scrolling:touch;flex-shrink:0}
.mode-bar::-webkit-scrollbar{display:none}
.mtab{display:flex;align-items:center;gap:5px;padding:10px 14px;white-space:nowrap;font-size:11.5px;font-weight:500;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;background:transparent;border-top:none;border-left:none;border-right:none;font-family:var(--sans);flex-shrink:0}
.mtab.active{color:var(--cyan);border-bottom-color:var(--cyan)}
.int-bar{background:var(--s2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px;padding:7px 12px;overflow-x:auto;flex-shrink:0}
.int-bar::-webkit-scrollbar{display:none}
.int-label{font-family:var(--mono);font-size:9px;color:var(--dim);white-space:nowrap;flex-shrink:0}
.ic{display:inline-flex;align-items:center;gap:4px;font-family:var(--mono);font-size:10px;border-radius:6px;padding:4px 9px;cursor:pointer;transition:all .15s;white-space:nowrap;flex-shrink:0;border:1px solid;opacity:.5}
.ic.on{opacity:1}
.ic.gmail{background:rgba(234,67,53,.08);border-color:rgba(234,67,53,.25);color:#ea4335}
.ic.cal{background:rgba(66,133,244,.08);border-color:rgba(66,133,244,.25);color:#4285f4}
.ic.drive{background:rgba(0,229,160,.08);border-color:rgba(0,229,160,.25);color:var(--green)}
.ic.docs{background:rgba(0,200,255,.08);border-color:rgba(0,200,255,.25);color:var(--cyan)}
.messages{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding:14px;display:flex;flex-direction:column;gap:12px;overscroll-behavior:contain}
.messages::-webkit-scrollbar{display:none}
.welcome{text-align:center;padding:16px 4px;max-width:100%}
.w-badge{display:inline-flex;align-items:center;gap:5px;font-family:var(--mono);font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--purple);background:var(--purple-d);border:1px solid rgba(167,139,250,.2);border-radius:20px;padding:4px 12px;margin-bottom:12px}
.welcome h1{font-size:26px;font-weight:700;line-height:1.2;letter-spacing:-.5px;margin-bottom:8px}
.welcome h1 em{font-style:normal;color:var(--cyan)}
.welcome p{color:var(--muted);font-size:12px;line-height:1.6;margin-bottom:18px;font-weight:300}
.pgrid{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.pcard{background:var(--s1);border:1px solid var(--border);border-radius:10px;padding:11px;cursor:pointer;transition:all .15s;text-align:left}
.pcard:active{border-color:var(--cyan);background:var(--s2);transform:scale(.98)}
.pcard-top{display:flex;align-items:center;gap:5px;margin-bottom:5px}
.pcard-icon{font-size:15px}
.pcard-src{font-family:var(--mono);font-size:8px;padding:1px 5px;border-radius:3px;border:1px solid}
.pcard-title{font-size:11.5px;font-weight:600;color:var(--txt);margin-bottom:2px}
.pcard-desc{font-size:10px;color:var(--muted);line-height:1.3}
.msg{display:flex;gap:9px;animation:msgIn .2s ease;max-width:100%}
@keyframes msgIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:none}}
.msg.user{flex-direction:row-reverse}
.av{width:26px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:9px;font-family:var(--mono);font-weight:600;flex-shrink:0;margin-top:2px}
.msg.ai .av{background:var(--cyan-d);color:var(--cyan);border:1px solid rgba(0,200,255,.2)}
.msg.user .av{background:var(--s2);color:var(--muted);border:1px solid var(--b2)}
.bubble{background:var(--s1);border:1px solid var(--border);border-radius:11px;padding:11px 13px;font-size:13px;line-height:1.65;color:var(--txt);max-width:calc(100% - 36px);word-break:break-word}
.msg.user .bubble{background:var(--s2);border-color:var(--b2)}
.src-badge{display:inline-flex;align-items:center;gap:4px;font-family:var(--mono);font-size:9px;border-radius:4px;padding:2px 6px;margin-bottom:7px;border:1px solid}
.bubble h3{font-family:var(--mono);font-size:9.5px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--cyan);margin:12px 0 6px;padding-bottom:4px;border-bottom:1px solid var(--cyan-d)}
.bubble h3:first-child{margin-top:0}
.bubble ul{list-style:none;padding:0;margin:4px 0}
.bubble li{padding:2px 0 2px 13px;position:relative;font-size:12.5px}
.bubble li::before{content:'‚ñ∏';position:absolute;left:0;color:var(--cyan);font-size:9px;top:4px}
.bubble strong{color:var(--green);font-weight:600}
.bubble code{font-family:var(--mono);font-size:11px;background:var(--s2);border:1px solid var(--b2);border-radius:3px;padding:1px 5px;color:var(--orange)}
.bubble table{width:100%;border-collapse:collapse;margin:8px 0;font-size:11.5px}
.bubble th{background:var(--s2);border:1px solid var(--b2);padding:5px 8px;font-family:var(--mono);font-size:8.5px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);text-align:left}
.bubble td{border:1px solid var(--border);padding:5px 8px;vertical-align:top}
.tag{display:inline-flex;align-items:center;font-family:var(--mono);font-size:9px;font-weight:500;border-radius:3px;padding:1px 5px;margin:1px 2px 1px 0}
.tag.fact{background:var(--green-d);color:var(--green);border:1px solid rgba(0,229,160,.15)}
.tag.interp{background:var(--cyan-d);color:var(--cyan);border:1px solid rgba(0,200,255,.15)}
.tag.hypo{background:var(--ora-d);color:var(--orange);border:1px solid rgba(255,157,61,.15)}
.tag.warn{background:var(--red-d);color:var(--red);border:1px solid rgba(255,77,109,.15)}
.btoolbar{display:flex;gap:5px;margin-top:9px;flex-wrap:wrap}
.btbtn{font-family:var(--sans);font-size:10.5px;color:var(--muted);background:var(--s2);border:1px solid var(--border);border-radius:4px;padding:3px 8px;cursor:pointer;transition:all .12s}
.btbtn:active{border-color:var(--cyan);color:var(--cyan)}
.typing{display:flex;align-items:center;gap:4px;padding:4px 0;height:20px}
.typing span{width:5px;height:5px;border-radius:50%;background:var(--cyan);animation:tb 1.1s infinite}
.typing span:nth-child(2){animation-delay:.18s}.typing span:nth-child(3){animation-delay:.36s}
@keyframes tb{0%,80%,100%{transform:scaleY(.5);opacity:.3}40%{transform:scaleY(1);opacity:1}}
.int-loading{display:flex;align-items:center;gap:7px;padding:6px 0;font-size:11.5px;color:var(--muted);font-family:var(--mono)}
.spin{width:13px;height:13px;border:2px solid var(--border);border-top-color:var(--cyan);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}
.drawer{background:var(--s1);border-top:1px solid var(--border);flex-shrink:0}
.chips{display:flex;overflow-x:auto;padding:7px 12px 5px;gap:6px;-webkit-overflow-scrolling:touch}
.chips::-webkit-scrollbar{display:none}
.chip{display:inline-flex;align-items:center;gap:4px;font-family:var(--mono);font-size:10px;color:var(--muted);background:var(--s2);border:1px solid var(--border);border-radius:20px;padding:4px 10px;cursor:pointer;white-space:nowrap;flex-shrink:0;transition:all .12s}
.chip:active{border-color:var(--cyan);color:var(--cyan);transform:scale(.96)}
.input-area{background:var(--s1);border-top:1px solid var(--border);padding:9px 12px calc(var(--safe-bot) + 9px);flex-shrink:0}
.file-ind{display:none;align-items:center;gap:5px;font-family:var(--mono);font-size:9px;color:var(--green);background:var(--green-d);border:1px solid rgba(0,229,160,.15);border-radius:5px;padding:3px 8px;margin-bottom:6px}
.fi-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fi-rm{background:none;border:none;color:var(--muted);cursor:pointer;font-size:12px;flex-shrink:0}
.input-row{display:flex;align-items:flex-end;gap:7px}
.input-wrap{flex:1;background:var(--bg);border:1.5px solid var(--b2);border-radius:11px;overflow:hidden;transition:border-color .15s}
.input-wrap:focus-within{border-color:var(--cyan)}
textarea{width:100%;background:transparent;border:none;outline:none;color:var(--txt);font-family:var(--sans);font-size:15px;line-height:1.5;resize:none;padding:10px 12px;min-height:42px;max-height:120px;-webkit-appearance:none}
textarea::placeholder{color:var(--dim)}
.ibtn{width:40px;height:40px;border-radius:9px;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;transition:all .12s;-webkit-appearance:none}
.send-btn{background:var(--cyan);color:var(--bg);font-weight:700}
.send-btn:active{transform:scale(.93);opacity:.85}
.send-btn:disabled{background:var(--border);color:var(--dim)}
.file-btn{background:var(--s2);border:1px solid var(--b2);color:var(--muted)}
.file-btn:active{border-color:var(--cyan);color:var(--cyan)}
#file-input{display:none}
*{scrollbar-width:none}
</style>
</head>
<body>

<div class="topbar">
  <div class="logo-row">
    <svg class="hex" viewBox="0 0 30 34" fill="none">
      <path d="M15 1L28 8.5V25.5L15 33L2 25.5V8.5L15 1Z" fill="rgba(0,200,255,0.08)" stroke="#00c8ff" stroke-width="1"/>
      <path d="M9 13L15 10L21 13V21L15 24L9 21V13Z" fill="#00c8ff" opacity=".9"/>
    </svg>
    <div class="app-name">LENAXIS<span>_ENG</span><span class="v-badge">V2</span></div>
  </div>
  <div class="status-pill"><div class="led"></div>CONNECT√â</div>
</div>

<div class="mode-bar">
  <button class="mtab active" onclick="setMode('analyse',this)">üîç Analyse</button>
  <button class="mtab" onclick="setMode('synthese',this)">üìã Synth√®se</button>
  <button class="mtab" onclick="setMode('reunion',this)">üéØ R√©union</button>
  <button class="mtab" onclick="setMode('rapport',this)">üìÑ Rapport</button>
  <button class="mtab" onclick="setMode('specs',this)">üìê Specs</button>
  <button class="mtab" onclick="setMode('risques',this)">‚ö†Ô∏è Risques</button>
</div>

<div class="int-bar">
  <span class="int-label">SOURCES :</span>
  <div class="ic gmail on" id="ic-gmail" onclick="toggleInt('gmail','ic-gmail')">üìß Gmail</div>
  <div class="ic cal on" id="ic-cal" onclick="toggleInt('cal','ic-cal')">üìÖ Agenda</div>
  <div class="ic drive on" id="ic-drive" onclick="toggleInt('drive','ic-drive')">‚òÅÔ∏è Drive</div>
  <div class="ic docs on" id="ic-docs" onclick="toggleInt('docs','ic-docs')">üìé Docs</div>
</div>

<div class="messages" id="messages">
  <div class="welcome" id="welcome">
    <div class="w-badge">‚ú¶ V2 ¬∑ Gmail ¬∑ Agenda ¬∑ Drive</div>
    <h1>Lenaxis<br><em>Ultra</em></h1>
    <p>Ton assistant connect√© √† toutes tes sources ‚Äî emails, agenda, Drive et documents joints.</p>
    <div class="pgrid">
      <div class="pcard" onclick="quick('Lis mes derniers emails non lus et identifie ce qui est urgent ou n√©cessite une action de ma part.')">
        <div class="pcard-top"><span class="pcard-icon">üìß</span><span class="pcard-src" style="background:rgba(234,67,53,.08);border-color:rgba(234,67,53,.2);color:#ea4335">GMAIL</span></div>
        <div class="pcard-title">Emails urgents</div>
        <div class="pcard-desc">R√©sum√© & actions prioritaires</div>
      </div>
      <div class="pcard" onclick="quick('Quelles sont mes r√©unions aujourd\'hui et demain ? Pr√©pare un brief de pr√©paration pour chacune.')">
        <div class="pcard-top"><span class="pcard-icon">üìÖ</span><span class="pcard-src" style="background:rgba(66,133,244,.08);border-color:rgba(66,133,244,.2);color:#4285f4">AGENDA</span></div>
        <div class="pcard-title">Brief du jour</div>
        <div class="pcard-desc">R√©unions & pr√©paration</div>
      </div>
      <div class="pcard" onclick="quick('Cherche dans mon Google Drive les documents techniques les plus r√©cents et fais-en une synth√®se.')">
        <div class="pcard-top"><span class="pcard-icon">‚òÅÔ∏è</span><span class="pcard-src" style="background:rgba(0,229,160,.08);border-color:rgba(0,229,160,.2);color:#00e5a0">DRIVE</span></div>
        <div class="pcard-title">Docs r√©cents</div>
        <div class="pcard-desc">Synth√®se Google Drive</div>
      </div>
      <div class="pcard" onclick="quick('Analyse le document joint, croise avec mes emails r√©cents sur ce sujet et donne-moi une synth√®se compl√®te.')">
        <div class="pcard-top"><span class="pcard-icon">üîó</span><span class="pcard-src" style="background:rgba(167,139,250,.08);border-color:rgba(167,139,250,.2);color:#a78bfa">MULTI</span></div>
        <div class="pcard-title">Analyse crois√©e</div>
        <div class="pcard-desc">Doc + emails + agenda</div>
      </div>
    </div>
  </div>
</div>

<div class="drawer">
  <div class="chips">
    <div class="chip" onclick="quick('R√©sume mes emails urgents non lus du jour.')">üìß Emails urgents</div>
    <div class="chip" onclick="quick('Brief de toutes mes r√©unions aujourd\'hui et demain.')">üìÖ R√©unions du jour</div>
    <div class="chip" onclick="quick('Synth√®se ex√©cutive de ce document :')">‚ö° Synth√®se doc</div>
    <div class="chip" onclick="quick('Cherche dans mon Drive les fichiers sur :')">‚òÅÔ∏è Drive</div>
    <div class="chip" onclick="quick('Quels sont les risques et points de vigilance ?')">‚ö†Ô∏è Risques</div>
    <div class="chip" onclick="quick('R√©dige le compte-rendu de ma derni√®re r√©union.')">üìù Compte-rendu</div>
    <div class="chip" onclick="quick('Plan d\'action prioritaire P1/P2/P3.')">‚úÖ Plan d\'action</div>
    <div class="chip" onclick="quick('Rapport technique structur√© bas√© sur :')">üìÑ Rapport</div>
  </div>
</div>

<div class="input-area">
  <div class="file-ind" id="file-ind">
    <span>üìé</span><span class="fi-name" id="fi-name"></span>
    <button class="fi-rm" onclick="clearFile()">‚úï</button>
  </div>
  <div class="input-row">
    <button class="ibtn file-btn" onclick="document.getElementById('file-input').click()">üìÇ</button>
    <input type="file" id="file-input" accept=".pdf,.txt,.doc,.docx,.md,.csv" onchange="handleFile(event)">
    <div class="input-wrap">
      <textarea id="inp" placeholder="Question, commande ou texte √† analyser‚Ä¶" rows="1"
        onkeydown="if(event.key==='Enter'&&!event.shiftKey&&window.innerWidth>768){event.preventDefault();send()}"
        oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px'"></textarea>
    </div>
    <button class="ibtn send-btn" id="send-btn" onclick="send()">‚ñ∂</button>
  </div>
</div>

<script>
var mode='analyse',history=[],busy=false,fileContent='',fileName='';
var ints={gmail:true,cal:true,drive:true,docs:true};

var SYSTEM=`Tu es LENAXIS V2, assistant d'ing√©nierie professionnel connect√© √† Gmail, Google Calendar et Google Drive.

ACCES DISPONIBLES :
- Gmail : lecture des emails, recherche, r√©sum√©s
- Google Calendar : agenda, r√©unions, √©v√©nements
- Google Drive : recherche et lecture de documents
- Documents joints directement dans la conversation

MISSION : Aider l'ing√©nieur √† travailler mieux et plus vite ‚Äî analyse de docs, synth√®ses, pr√©paration de r√©unions, rapports, suivi d'actions.

PRINCIPES ABSOLUS :
- Ne jamais inventer. Si tu ne sais pas ou n'as pas acc√®s ‚Üí tu le dis clairement.
- Distinguer FAIT / INTERPR√âTATION / HYPOTH√àSE
- Signaler les lacunes explicitement.
- Phrases courtes. Direct. Orient√© d√©cision.
- Toujours en fran√ßais.
- Quand tu utilises Gmail/Calendar/Drive, cite clairement la source.
- Finir par 2-3 suggestions d'approfondissement.

FORMAT : titres ## courts, listes avec ‚ñ∏, tableaux si utile, priorit√©s et deadlines en gras.`;

var MODES={
  analyse:'MODE ANALYSE : Extrais l\'essentiel, distingue fait/interpr√©tation/hypoth√®se, signale les lacunes.',
  synthese:'MODE SYNTH√àSE : 5-10 points max, du plus important au moins, chaque point actionnable.',
  reunion:'MODE R√âUNION TECHNIQUE : ‚Üí Points incontournables ‚Üí Questions cl√©s ‚Üí Donn√©es n√©cessaires ‚Üí Risques de blocage ‚Üí D√©cisions attendues. Utilise l\'agenda pour contextualiser.',
  rapport:'MODE RAPPORT : Executive summary (3-5 lignes) ‚Üí Contexte ‚Üí Analyse ‚Üí Observations ‚Üí Recommandations P1/P2/P3 ‚Üí Conclusions.',
  specs:'MODE SPECS/CDC : Exigences fonctionnelles ‚Üí Exigences techniques ‚Üí Contraintes ‚Üí Hypoth√®ses ‚Üí Ambigu√Øt√©s et manques.',
  risques:'MODE RISQUES : Description, cat√©gorie, probabilit√© (F/M/E), impact, mitigation. Matrice de criticit√© en conclusion.'
};

function setMode(m,el){mode=m;document.querySelectorAll('.mtab').forEach(t=>t.classList.remove('active'));el.classList.add('active');}
function toggleInt(k,id){ints[k]=!ints[k];document.getElementById(id).classList.toggle('on',ints[k]);}
function quick(t){var inp=document.getElementById('inp');inp.value=t;inp.style.height='auto';inp.style.height=Math.min(inp.scrollHeight,120)+'px';inp.focus();}
function scroll(){var m=document.getElementById('messages');m.scrollTop=m.scrollHeight;}
function removeWelcome(){var w=document.getElementById('welcome');if(w)w.remove();}

function handleFile(e){
  var f=e.target.files[0];if(!f)return;fileName=f.name;
  var r=new FileReader();
  r.onload=function(ev){fileContent=ev.target.result;showFI();};
  if(f.name.match(/\.pdf$/i)){fileContent='[PDF: '+f.name+' ‚Äî '+Math.round(f.size/1024)+'KB]';showFI();}
  else r.readAsText(f);
}
function showFI(){document.getElementById('fi-name').textContent=fileName;document.getElementById('file-ind').style.display='flex';}
function clearFile(){fileContent='';fileName='';document.getElementById('file-ind').style.display='none';document.getElementById('file-input').value='';}

function esc(t){return(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');}

function renderMD(raw){
  var t=(raw||'')
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\*\*([^*\n]+)\*\*/g,'<strong>$1</strong>')
    .replace(/`([^`\n]+)`/g,'<code>$1</code>')
    .replace(/^#{1,3} (.+)$/gm,'<h3>$1</h3>')
    .replace(/\[FAIT\]/g,'<span class="tag fact">‚óè FAIT</span>')
    .replace(/\[INTERPR√âTATION\]/g,'<span class="tag interp">‚óà INTERPR√âT.</span>')
    .replace(/\[HYPOTH√àSE\]/g,'<span class="tag hypo">‚óá HYPOTH√àSE</span>')
    .replace(/\[ATTENTION\]/g,'<span class="tag warn">‚ñ≤ ATTENTION</span>')
    .replace(/\[MANQUANT\]/g,'<span class="tag interp">‚óã MANQUANT</span>')
    .replace(/^[‚ñ∏\-‚Ä¢*] (.+)$/gm,'<li>$1</li>')
    .replace(/^\d+\. (.+)$/gm,'<li>$1</li>');
  t=t.replace(/(<li>.*?<\/li>\n?)+/g,function(m){return'<ul>'+m+'</ul>';});
  return t.split('\n').map(function(l){
    var tr=l.trim();
    if(!tr)return'<div style="height:4px"></div>';
    if(/^<(h3|ul|table|div)/.test(tr))return tr;
    return'<p style="margin-bottom:3px">'+tr+'</p>';
  }).join('');
}

function srcBadge(text){
  var l=text.toLowerCase();
  if(l.includes('gmail')||l.includes('email')||l.includes('mail'))return'<div class="src-badge" style="background:rgba(234,67,53,.08);border-color:rgba(234,67,53,.2);color:#ea4335">üìß Gmail</div>';
  if(l.includes('calendar')||l.includes('agenda')||l.includes('r√©union'))return'<div class="src-badge" style="background:rgba(66,133,244,.08);border-color:rgba(66,133,244,.2);color:#4285f4">üìÖ Agenda</div>';
  if(l.includes('drive'))return'<div class="src-badge" style="background:rgba(0,229,160,.08);border-color:rgba(0,229,160,.2);color:#00e5a0">‚òÅÔ∏è Drive</div>';
  return'';
}

function addUserMsg(text){
  removeWelcome();
  var d=document.createElement('div');d.className='msg user';
  d.innerHTML='<div class="av">YOU</div><div class="bubble">'+esc(text)+'</div>';
  document.getElementById('messages').appendChild(d);scroll();
}

function addTyping(){
  removeWelcome();
  var d=document.createElement('div');d.className='msg ai';d.id='typing';
  d.innerHTML='<div class="av">AI</div><div class="bubble"><div class="typing"><span></span><span></span><span></span></div></div>';
  document.getElementById('messages').appendChild(d);scroll();
}

function setTypingText(text){
  var d=document.getElementById('typing');
  if(d)d.querySelector('.bubble').innerHTML='<div class="int-loading"><div class="spin"></div>'+text+'</div>';
}

function removeTyping(){var d=document.getElementById('typing');if(d)d.remove();}

function addAIMsg(text){
  var badge=srcBadge(text);
  var d=document.createElement('div');d.className='msg ai';
  d.innerHTML='<div class="av">AI</div><div class="bubble">'+badge+renderMD(text)+'<div class="btoolbar"><button class="btbtn" onclick="copyB(this)">üìã Copier</button><button class="btbtn" onclick="quick(\'Approfondir ce point : \')">üîç +</button><button class="btbtn" onclick="quick(\'Condense en 5 points max.\')">‚úÇÔ∏è</button><button class="btbtn" onclick="quick(\'Transforme en rapport structur√©.\')">üìÑ Rapport</button></div></div>';
  document.getElementById('messages').appendChild(d);scroll();
}

function copyB(btn){
  var t=btn.closest('.bubble').innerText.replace(/üìã Copier|üîç \+|‚úÇÔ∏è|üìÑ Rapport/g,'').trim();
  navigator.clipboard.writeText(t).catch(function(){});
  btn.textContent='‚úÖ';setTimeout(function(){btn.textContent='üìã Copier';},2000);
}

async function send(){
  if(busy)return;
  var inp=document.getElementById('inp');
  var text=inp.value.trim();if(!text)return;

  var userContent=text;
  if(fileContent)userContent+='\n\n---\nDocument joint : '+fileName+'\n\n'+fileContent.slice(0,10000);

  var activeList=Object.entries(ints).filter(function(e){return e[1];}).map(function(e){return e[0];}).join(', ');
  if(activeList)userContent+='\n\n[Sources actives : '+activeList+']';

  addUserMsg(text);
  inp.value='';inp.style.height='auto';inp.blur();
  history.push({role:'user',content:userContent});

  busy=true;
  document.getElementById('send-btn').disabled=true;
  addTyping();

  var mcpServers=[];
  if(ints.gmail){setTypingText('Lecture Gmail‚Ä¶');mcpServers.push({type:"url",url:"https://gmail.mcp.claude.com/mcp",name:"gmail-mcp"});}
  if(ints.cal){setTypingText('Lecture Agenda‚Ä¶');mcpServers.push({type:"url",url:"https://gcal.mcp.claude.com/mcp",name:"gcal-mcp"});}

  try{
    var body={
      model:'claude-sonnet-4-20250514',
      max_tokens:1000,
      system:SYSTEM+'\n\n---\n'+MODES[mode],
      messages:history
    };
    if(mcpServers.length>0)body.mcp_servers=mcpServers;

    setTypingText('Analyse en cours‚Ä¶');

    var res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });

    var data=await res.json();
    if(data.error)throw new Error(data.error.message);

    var reply=(data.content||[]).filter(function(b){return b.type==='text';}).map(function(b){return b.text||'';}).join('');
    history.push({role:'assistant',content:reply||'R√©ponse re√ßue.'});
    removeTyping();
    addAIMsg(reply||'R√©ponse re√ßue.');

  }catch(err){
    removeTyping();
    addAIMsg('Erreur : '+err.message);
  }

  busy=false;
  document.getElementById('send-btn').disabled=false;
}

if('serviceWorker' in navigator)navigator.serviceWorker.register('/sw.js').catch(function(){});

if(/iphone|ipad|ipod/i.test(navigator.userAgent)&&!navigator.standalone){
  setTimeout(function(){
    var b=document.createElement('div');
    b.style.cssText='position:fixed;bottom:80px;left:12px;right:12px;background:#0e3d4f;border:1px solid rgba(0,200,255,.2);border-radius:10px;padding:10px 14px;z-index:999;display:flex;align-items:center;gap:10px;font-size:12px;color:#cdd9ed';
    b.innerHTML='<span style="font-size:20px">üì≤</span><div style="flex:1"><strong style="color:#00c8ff;display:block">Installer Lenaxis</strong>Safari ‚Üí Partager ‚Üí Sur l\'√©cran d\'accueil</div><button onclick="this.parentElement.remove()" style="background:none;border:none;color:#546e8a;cursor:pointer;font-size:18px">‚úï</button>';
    document.body.appendChild(b);
  },3000);
}
</script>
</body>
</html>
